
##Tree simulation: SimPhy 
####################################

simphy -Rs 10000 -Rl U:10,500 -Rg 1 -St U:100000,10000000 -si U:1,5 -Sl U:10,50 -Sb L:-14,1.6 -SP L:12,0.5 -Hs L:1.5,1 -Hl L:1.2,1 -Hg L:1.4,1 -SU E:10000000 -OD 1 -op 1 -oc 1 -v 1 -So SL:0,0.1,0.5 -Cs 22 -O sim_broadsims

##Sequence simulation: post_simphy.pl + indelible
#################################################
module load perl

perl ./scripts/post_simphy.pl sim_broadsims 1

qsub -t 1-10000 -e e_log/ -o o_log/ scripts/run_indelible.sh sim_broadsims/

## Elimination of redundant files
################################################
for i in sim_broadsims/*/ ; do rm -f $i/*.fas;rm -f $i/trees.txt;done

## Gene tree estimation
################################################
qsub -p -5 -t 1-10000 -e e_log/ -o o_log/ -q compute-1-x.q,compute-0-x.q scripts/run_raxml_gtree.sh sim_broadsims/

./check_raxml_gtree.sh ../sim_broadsims/ to_repeat.txt 5000 ##After cluster stopped

while read line; do qsub -p -5 -e e_log/ -o o_log/ -q compute-1-x.q,compute-0-x.q scripts/rerun_raxml_gtree.sh sim_broadsims/ $line;done < scripts/to_repeat.txt

#Something may be missing here with the check_raxml_gtree.sh but it is not really necessary
./check_raxml_gtree2.sh > check.out2 ##Problematic replicates
loop_rerun_raxml_gtree_perep.sh check.out2 > check.log ##Executing failed replicates with a different seed and logging the output for posterior debuging

curdir="/home/dmallo/broadsims/new/scripts"
datadir="/home/dmallo/broadsims/new/sim_broadsims"
while IFS="," read folder rep id; do if [[ $(grep -c "Overall execution time" /home/dmallo/broadsims/new/repOlogs/rerun_raxml_gtree_perep.sh.o${id}) -eq 1 ]]; then echo $folder $rep Done; elif [[ $(grep -c "state number . is equal to zero in" /home/dmallo/broadsims/new/repOlogs/rerun_raxml_gtree_perep.sh.o${id}) -ne 0 ]]; then echo $folder $rep = missing data; elif [[ $(grep -c "setRateModel" /home/dmallo/broadsims/new/repOlogs/rerun_raxml_gtree_perep.sh.o${id}) -eq 1 ]]; then cd $datadir/$folder; qid=$(qsub -q compute-1-x.q,compute-0-x.q,compute-2-x.q -j y -e ../../repElogs/ -o ../../repOlogs/ $curdir/rerun_raxml_gtree_perep_cat.sh ${rep}_TRUE.phy | sed "s/.*job\ \(.*\)\ (.*/\1/"); echo New job $qid with GTRCAT for $folder $rep; cd $curdir; else echo $id Unknown error; fi;done<check.log>check2.log ###Still working on this

## Concatenation
###############################################
qsub -p -1 -t 1-10000 -e e_log/ -o o_log/ -q compute-1-x.q,compute-0-x.q scripts/concatenate.sh sim_broadsims/
qsub -p -1 -t 1-10000 -e e_log/ -o o_log/ -q gpu.q scripts/build_constraint_tree.sh sim_broadsims/
qsub -p -4 -t 1-10000 -e e_log/ -o o_log/ -q compute-1-x.q,compute-0-x.q scripts/run_raxml_concat.sh sim_broadsims/ ##Actually I'm running this in Finisterrae2 using a different script

