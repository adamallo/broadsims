
##Tree simulation: SimPhy 
####################################

simphy -Rs 10000 -Rl U:10,500 -Rg 1 -St U:100000,10000000 -si U:1,5 -Sl U:10,50 -Sb L:-14,1.6 -SP L:12,0.5 -Hs L:1.5,1 -Hl L:1.2,1 -Hg L:1.4,1 -SU E:10000000 -OD 1 -op 1 -oc 1 -v 1 -So SL:0,0.1,0.5 -Cs 22 -O sim_broadsims

##Sequence simulation: post_simphy.pl + indelible
#################################################
module load perl

perl ./scripts/post_simphy.pl sim_broadsims 1

qsub -t 1-10000 -e e_log/ -o o_log/ scripts/run_indelible.sh sim_broadsims/

## Elimination of redundant files
################################################
for i in sim_broadsims/*/ ; do rm -f $i/*.fas;rm -f $i/trees.txt;done

## Gene tree estimation
################################################
qsub -p -5 -t 1-10000 -e e_log/ -o o_log/ -q compute-1-x.q,compute-0-x.q scripts/run_raxml_gtree.sh sim_broadsims/

./check_raxml_gtree.sh ../sim_broadsims/ to_repeat.txt 5000 ##After cluster stopped

while read line; do qsub -p -5 -e e_log/ -o o_log/ -q compute-1-x.q,compute-0-x.q scripts/rerun_raxml_gtree.sh sim_broadsims/ $line;done < scripts/to_repeat.txt

#Something may be missing here with the check_raxml_gtree.sh but it is not really necessary
./check_raxml_gtree2.sh > check.out2 ##Problematic replicates
loop_rerun_raxml_gtree_perep.sh check.out2 > check.log ##Executing failed replicates with a different seed and logging the output for posterior debuging

curdir="/home/dmallo/broadsims/new/scripts"
datadir="/home/dmallo/broadsims/new/sim_broadsims"
while IFS="," read folder rep id; do if [[ $(grep -c "Overall execution time" /home/dmallo/broadsims/new/repOlogs/rerun_raxml_gtree_perep.sh.o${id}) -eq 1 ]]; then echo $folder $rep Done; elif [[ $(grep -c "state number . is equal to zero in" /home/dmallo/broadsims/new/repOlogs/rerun_raxml_gtree_perep.sh.o${id}) -ne 0 ]]; then echo $folder $rep = missing data; elif [[ $(grep -c "setRateModel" /home/dmallo/broadsims/new/repOlogs/rerun_raxml_gtree_perep.sh.o${id}) -eq 1 ]]; then cd $datadir/$folder; qid=$(qsub -q compute-1-x.q,compute-0-x.q,compute-2-x.q -j y -e ../../repElogs/ -o ../../repOlogs/ $curdir/rerun_raxml_gtree_perep_cat.sh ${rep}_TRUE.phy | sed "s/.*job\ \(.*\)\ (.*/\1/"); echo New job $qid with GTRCAT for $folder $rep; cd $curdir; else echo $id Unknown error; fi;done<check.log>check2.log ###Still working on this

## Concatenation
###############################################
qsub -p -1 -t 1-10000 -e e_log/ -o o_log/ -q compute-1-x.q,compute-0-x.q scripts/concatenate.sh sim_broadsims/
qsub -p -1 -t 1-10000 -e e_log/ -o o_log/ -q gpu.q scripts/build_constraint_tree.sh sim_broadsims/
qsub -p -4 -t 1-10000 -e e_log/ -o o_log/ -q compute-1-x.q,compute-0-x.q scripts/run_raxml_concat.sh sim_broadsims/ ##Actually I'm running this in Finisterrae2 using a different script

##In finisterrae2
###############################################
#Data collection
home="/home/uvi/be/dma/lustre/broadsims";for i in *; do if [[ -d $i/concat ]] && [[ ! -f $i/concat/raxml_files.tar.gz ]]; then cd $i/concat; mkdir raxml_files; mv RAxML* raxml_files; tar -cvzf raxml_files.tar.gz raxml_files; rm -rf raxml_files; cd $home ;fi;done

##Species tree estimation
#########################

qsub -q compute-0-x.q,compute-1-x.q -t 1-10000 -e ../e_log/ -o ../o_log/ run_mrpmatrix.sh
qsub -q compute-0-x.q,compute-1-x.q -t 1-10000 -e ../e_log/ -o ../o_log/ run_greedy.sh
qsub -q compute-0-x.q,compute-1-x.q -t 1-10000 -p -1 -e ../e_log/ -o ../o_log/ run_mrl.sh
qsub -q compute-0-x.q,compute-1-x.q -t 1-10000:4 -pe threaded 4 -e ../e_log/ -o ../o_log/ run_mpest.sh 4
qsub -q compute-0-x.q,compute-1-x.q -t 1-10000:4 -pe threaded 4 -e ../e_log/ -o ../o_log/ run_njst_star_steac.sh 4
qsub -q compute-0-x.q,compute-1-x.q -t 1-10000 -e ../e_log/ -o ../o_log/ run_astral.sh

##Estimation of 500 concatenation trees at random to compare speeds with finisterrae2
#####################################################################################
#random=$(awk -v min=1 -v max=10000 -v n=500 -v seed=25 'BEGIN{srand(seed); for (i=0;i<n;++i) printf("%05d ",int(min+rand()*(max-min+1)))}') ##Error
random=$(awk -v min=1 -v max=10000 -v n=500 -v seed=25 'BEGIN{srand(seed);newr=""; for (i=0;i<n;++i) {r=sprintf("%05d",int(min+rand()*(max-min+1)));if (match(newr,r)){--i} else{newr=newr " " r;print r}}}')
for i in $random; do qsub -q compute-0-x.q,compute-1-x.q -e e_log/ -o o_log/ scripts/run_raxml_concat2.sh sim_broadsims $i;done > scripts/concat2.log

##DATA RECOLECTION
##################

#List if times for speed comparison
for i in *; do if [[ -d $i ]]; then if [[ -s $i/concat/time2.stat ]]; then echo $i >> concat2.list;fi;fi;done

#Times for the 500 trees
while read line; do qsub -q compute-1-x.q,compute-0-x.q ../scripts/get_times_concat2.sh $line;done < concat2.list

#Get gtree error
qsub -q compute-1-x.q,compute-0-x.q -e /home/dmallo/broadsims/new/sim_broadsims/newe_log -o /home/dmallo/broadsims/new/sim_broadsims/newo_log -t 1-10000 scripts/RF_gtrees.sh

#Get stree error
qsub -q compute-1-x.q,compute-0-x.q -e /home/dmallo/broadsims/new/sim_broadsims/newe_log -o /home/dmallo/broadsims/new/sim_broadsims/newo_log -t 1-10000 scripts/RF_strees.sh

#Get times for gtree (this has to be finised to start the next, they are dependent)

qsub -q compute-1-x.q,compute-0-x.q -e /home/dmallo/broadsims/new/sim_broadsims/newe_log -o /home/dmallo/broadsims/new/sim_broadsims/newo_log -t 1-10000 scripts/get_times_gtrees.sh

#Get times for stree

qsub -q compute-1-x.q,compute-0-x.q -e /home/dmallo/broadsims/new/sim_broadsims/newe_log -o /home/dmallo/broadsims/new/sim_broadsims/newo_log -t 1-10000 scripts/get_times_strees.sh

##Putting together the RFs, times and gRFs
echo "rep,rf,method" > rf.csv; echo "rep,time,stime,method" > times.csv;echo "rep,mrf,sdrf" > grf.csv; for i in *; do if [[ -d $i ]]; then tail -n+2 $i/data/rf.csv >> rf.csv; tail -n+2 $i/data/times.csv >> times.csv;echo "$i,"$(tail -n+2 $i/data/gtrees_rfsummary.csv) >> grf.csv;fi;done
echo "rep,time,stime,method" > times2.csv; while read id; do tail -n+2 $id/data/times2.csv >> times2.csv;done < concat2.list
